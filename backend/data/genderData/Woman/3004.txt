ALBANY  —   State lawmakers on Friday reached a   deal to conclude the 2016 legislative session that included a modest ethics package, state funding for supportive housing for the homeless, and a   extension  —   with major caveats  —   of Mayor Bill de Blasio’s control of New York City schools. Consensus on the ethics reform seemed to come quickly on Friday, the day after the last official day of the legislative session. The deal would, among other things, strip state pensions from public officials convicted of corruption and strengthen prohibitions on political campaigns’ ability to coordinate with independent expenditure committees. But a similar consensus kept lurching out of reach on the issue that mattered most to Mr. de Blasio: mayoral control. In the end, he ceded significant concessions to his Albany antagonists in exchange for an extension of a single year, down from the three years he had hoped for. Bowing to demands from the State Senate majority leader, John J. Flanagan, a Republican who is not disposed to be helpful to a mayor who has openly worked to flip control of the chamber to the Democrats, the mayor and his allies in the   Assembly agreed to disclose more information about city school districts’ spending and to accept a change to the oversight structure for more than half the city’s charter schools. A   extension, with few or no caveats, had seemed all but cemented when lawmakers went to bed on Thursday evening. But the morning found Mr. Flanagan pushing for the funding transparency requirement, followed by the   provision in the afternoon. It would effectively create a parallel system of charter schools within the city, allowing “  charter schools in good standing” to switch to join the State University of New York umbrella or the Board of Regents of the State Education Department. City Hall gritted its teeth. “This extension is a recognition of the unprecedented progress and achievements mayoral control has delivered for our school system,” Austin Finan, a spokesman for the mayor’s office, said in a statement. For people outside city education circles, however, there was plenty of meat in the agreement that Mr. Flanagan Gov. Andrew M. Cuomo, a Democrat and the Assembly speaker, Carl E. Heastie, a Democrat, announced on Friday evening. Lawmakers also agreed to require school districts to test for lead in drinking water, with the state paying for some of the testing costs. The adoption of the lead testing bill was a victory for Assemblywoman Catherine T. Nolan, a Queens Democrat, who heads the Education Committee and who had been criticized for blocking a previous bill that she considered too broad. Under the new bill, schools would be required to periodically test for lead  —   though some already do  —   and notify parents in the event the dangerous element is discovered. The state will also provide an additional $50 million in capital funding for SUNY and the City University of New York. But the governor’s announcement that the state would release $570 million in state resources to build and operate 1, 200 units of supportive housing for the homeless was immediately dissected and dismissed by advocates for the program, who said it fell far short of Mr. Cuomo’s initial commitment to pay for 20, 000 units. “Tonight’s plan would appear to be a betrayal of the most vulnerable New Yorkers and the latest broken promise from a governor who makes sweeping announcements that lead to paltry results,” the Campaign 4   Housing, a supportive housing group, said in a statement. Mr. Cuomo and the legislative leaders had already agreed to funding for 6, 000 units over five years as part of the state budget passed in March, but another deal was required to release the first infusion of money for spending. The $570 million figure included only $150 million of new state funding, said Assemblyman Andrew Hevesi, the chairman of the Assembly’s Social Services Committee, with the rest coming from existing capital funds and tax credits. “In January, it was 20, 000 units,” he said. “In April, it was 6, 000 units. Now it’s 1, 200 units and it’s only $150 million in new money. All the rest is smoke and mirrors. ” Early Saturday morning, the lawmakers were in the process of passing the new legislation. At about 2:15 a. m. the Legislature finished its last remaining substantive task: the Senate passed a bill to legalize daily fantasy sports, which had been considered illegal gambling in New York. The Assembly had approved the measure on Friday afternoon. Other   bills won both houses’ backing on Friday. The Legislature passed a bill that aims to ensure equal access to legal representation for the poor by reimbursing counties for indigent legal services, drawing praise from the New York Civil Liberties Union. The hotel industry in New York City cheered the passage of legislation that would keep people from advertising stays shorter than 30 days in unoccupied homes, a measure that the bill’s supporters said would restrict commercial operators of illegal hotels, but that Airbnb  —   the company that prompted the bill  —   said would affect regular city residents. It is already illegal in New York to rent out an empty apartment for less than 30 days at a time. The Legislature also passed bills that would increase penalties for using software known as ticket bots to scoop up large numbers of tickets to concerts, games or other events, a practice that the state attorney general, Eric T. Schneiderman, highlighted in a recent report. Doing so is already illegal, but the bill would make it a misdemeanor. The agreement on Friday, which came after a flurry of deals at the March budget deadline, including an increase in the minimum wage and the establishment of a paid family leave program, did not please corporate leaders like Heather Briccetti, the president of the Business Council of New York State, who called it devoid of any “major   or cost reduction measures. ” Nor did it mollify government watchdogs and other advocates of ethics reforms who had high hopes that the convictions last year of Sheldon Silver, the former Assembly speaker, and Dean G. Skelos, the former Senate majority leader, would finally shame the Legislature into acting to prevent corruption. But of all the measures on ethics that lawmakers did discuss this session, pension forfeiture, a straightforward and broadly popular measure, was the only prominent one to survive. Mr. Cuomo had proposed but failed to win support for more ambitious proposals that included eight different bills for closing a   loophole that allows limited liability companies to donate to political candidates up to the limit for individual contributors, rather than for businesses. In order for pension forfeiture to become a constitutional amendment, two consecutively elected legislatures must approve it before voters consider the measure on the ballot. The announcement about the ethics agreement highlighted what were called strong protections against the independent expenditure committees empowered by the Citizens United ruling, the Supreme Court’s 2010 campaign finance decision. The governor had made a push to tighten restrictions on such committees over the past few weeks. The ethics package will also require political consultants who simultaneously advise elected officials or candidates and work with companies that have business before the state to register with the state and disclose their clients. It strengthens disclosure requirements for lobbyists and for   nonprofits that lobby the state to disclose financial support from other nonprofits that are not supposed to engage in political activity. Blair Horner, the executive director for the New York Public Interest Research Group, said the deal was a “smorgasbord of elections, ethics and lobbying reforms” that nonetheless was “not focused at the heart of what’s wrong with Albany,” including the nearly unchecked flow of money through multiple limited liability companies. That said, Mr. Horner said the move to define coordination between independent expenditure committees and candidates was an improvement. “No one has defined what that means,” he said. “And this does. ” The greatest source of friction on Friday appeared to be the mayoral control issue. There was concern within City Hall that the charter school provision would significantly change how such schools in the city run. Charter schools can be authorized by three agencies  —   the State Education Department, the city’s Education Department and SUNY  —   but all operate according to the same state law. Although the announcement of the agreement did not offer details, the Senate’s proposal would exempt SUNY schools from the usual state standards and free to set their own rules, two officials with direct knowledge of the negotiations said. There are 111 charters authorized by SUNY in the city. Another 55 are authorized by the city’s Education Department, and 39 by the state department.